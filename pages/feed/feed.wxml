<!--pages/feed/feed.wxml - æ–°ç‰ˆå¡ç‰‡å¼è®¾è®¡-->
<view class="feed-container">

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-container">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="loadFeedData">é‡æ–°åŠ è½½</button>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ - æ»šåŠ¨è§†å›¾ -->
  <scroll-view wx:else scroll-y="{{viewState !== 'judging'}}" class="feed-scroll">

    <!-- åˆ¤å®šå‰çŠ¶æ€ -->
    <view wx:if="{{viewState === 'judging'}}" class="judgment-view">

      <!-- æ ‡é¢˜ -->
      <view class="page-title">è°æ˜¯äººæœº?</view>

      <!-- å†…å®¹åŒºåŸŸï¼ˆå¼•å·+å¡ç‰‡ï¼‰ -->
      <view class="content-wrapper">
        <view class="quote-icon">"</view>

        <!-- è§†é¢‘å†…å®¹ -->
        <view wx:if="{{currentItem.type === 'video'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <video
              id="content-video"
              class="content-video"
              src="{{currentItem.url}}"
              object-fit="contain"
              show-center-play-btn="{{true}}"
              show-play-btn="{{false}}"
              controls="{{true}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
            ></video>
          </view>
        </view>

        <!-- å›¾ç‰‡å†…å®¹ -->
        <view wx:elif="{{currentItem.type === 'image'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <image class="content-image" src="{{currentItem.url}}" mode="aspectFit"></image>
          </view>
        </view>

        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:else class="content-card">
          <text class="content-text">{{currentItem.text || currentItem.title}}</text>
        </view>
      </view>

      <!-- åˆ¤å®šæŒ‰é’® -->
      <view class="action-buttons">
        <button class="btn-judge btn-ai" bindtap="handleJudge" data-choice="ai">
          è¯¥æ˜¯äººæœº!
        </button>
        <button class="btn-judge btn-human" bindtap="handleJudge" data-choice="human">
          åŒ…çœŸäººçš„!
        </button>
      </view>

    </view>

    <!-- åˆ¤å®šåçŠ¶æ€ -->
    <view wx:elif="{{viewState === 'revealed'}}" class="result-view">

      <!-- ç»“æœæç¤º -->
      <view class="result-header">
        <text class="result-title">{{isCorrect ? 'ä½ çœŸæ˜¯åˆ«å…·æ…§çœ¼ï¼é€‰æ‹©ä¸ç»“æœä¸€è‡´ï¼' : 'å¾ˆé—æ†¾ï¼Œè¿™æ¬¡åˆ¤æ–­å¤±è¯¯äº†'}}</text>
      </view>

      <!-- ç»Ÿè®¡æ¡ -->
      <view class="stats-bar">
        <view class="stat-item stat-ai" style="width: {{currentItem.aiPercentage || 28}}%">
          <text class="stat-text">{{currentItem.aiPercentage || 28}}%</text>
        </view>
        <view class="stat-item stat-human" style="width: {{100 - (currentItem.aiPercentage || 28)}}%">
          <text class="stat-text">{{100 - (currentItem.aiPercentage || 28)}}%</text>
        </view>
      </view>

      <!-- æ¥æºä¿¡æ¯ -->
      <view class="source-info">
        è¯¥å†…å®¹æ˜¯ {{currentItem.isAi ? 'ğŸ¤– AI' : 'ğŸ‘¤ çœŸäºº'}} {{currentItem.provider}} æ•°æ®æä¾›ã€‚
      </view>

      <!-- å†…å®¹å¡ç‰‡ -->
      <view class="content-card-wrapper">
        <view class="quote-icon">"</view>

        <!-- è§†é¢‘å†…å®¹ -->
        <view wx:if="{{currentItem.type === 'video'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <video
              id="result-video"
              class="content-video"
              src="{{currentItem.url}}"
              object-fit="contain"
              show-center-play-btn="{{true}}"
              show-play-btn="{{false}}"
              controls="{{true}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
            ></video>
          </view>
        </view>

        <!-- å›¾ç‰‡å†…å®¹ -->
        <view wx:elif="{{currentItem.type === 'image'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <image class="content-image" src="{{currentItem.url}}" mode="aspectFit"></image>
          </view>
        </view>

        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:else class="content-card">
          <text class="content-text">{{currentItem.text || currentItem.title}}</text>
        </view>
      </view>

      <!-- è§£æè¯´æ˜ -->
      <view wx:if="{{currentItem.explanation}}" class="explanation-box">
        <text class="explanation-label">è¯¥å†…å®¹æ˜¯ {{currentItem.modelTag}} ç”Ÿæˆ</text>
        <text class="explanation-text">{{currentItem.explanation}}</text>
      </view>

      <!-- è¯„è®ºåŒºåŸŸ -->
      <view class="comments-section">
        <!-- è¯„è®ºé¢„è§ˆ/å…¥å£ -->
        <view class="comments-preview" bindtap="toggleComments">
          <view class="comments-preview-header">
            <text class="comments-preview-title">ğŸ’¬ çœ‹å¤§å®¶è¯„è®º</text>
            <view class="comments-preview-info">
              <text class="comments-count">{{comments.length}}æ¡è¯„è®º</text>
              <text class="expand-icon">{{showComments ? 'â–²' : 'â–¼'}}</text>
            </view>
          </view>

          <!-- æ˜¾ç¤ºå‰2æ¡è¯„è®ºé¢„è§ˆ -->
          <view wx:if="{{!showComments && comments.length > 0}}" class="comments-preview-list">
            <block wx:for="{{comments}}" wx:key="id" wx:if="{{index < 2}}">
              <view class="comment-preview-item">
                <text class="preview-author">{{item.user ? item.user.nickname : 'æ¸¸å®¢'}}</text>
                <text class="preview-content">: {{item.content}}</text>
              </view>
            </block>
          </view>
        </view>

        <!-- å®Œæ•´è¯„è®ºåŒºåŸŸï¼ˆå±•å¼€åæ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{showComments}}" class="comments-full">
          <!-- è¯„è®ºè¾“å…¥æ¡† -->
          <view class="comment-input-wrapper">
            <input
              class="comment-input"
              placeholder="{{replyingTo ? 'å›å¤ ' + replyingTo.user.nickname : 'è¯´ç‚¹ä»€ä¹ˆ...'}}"
              value="{{commentInput}}"
              bindinput="onCommentInput"
              maxlength="500"
              confirm-type="send"
              bindconfirm="submitComment"
            />
            <button class="comment-submit-btn" bindtap="submitComment">å‘é€</button>
          </view>

          <!-- è¯„è®ºåˆ—è¡¨ -->
          <view class="comments-list">
            <view wx:if="{{comments.length === 0}}" class="empty-comments">
              <text class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
            </view>

            <block wx:for="{{comments}}" wx:key="id">
              <view class="comment-item">
                <!-- ç”¨æˆ·å¤´åƒ -->
                <image
                  class="comment-avatar"
                  src="{{item.user ? item.user.avatar : '/images/default-avatar.png'}}"
                  mode="aspectFill"
                />

                <view class="comment-main">
                  <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ—¶é—´ -->
                  <view class="comment-header">
                    <text class="comment-nickname">{{item.user ? item.user.nickname : 'æ¸¸å®¢'}}</text>
                    <text wx:if="{{item.user}}" class="comment-level">Lv.{{item.user.level}}</text>
                    <text class="comment-time">{{item.createdAt}}</text>
                  </view>

                  <!-- è¯„è®ºå†…å®¹ -->
                  <text class="comment-content">{{item.content}}</text>

                  <!-- æ“ä½œæŒ‰é’® -->
                  <view class="comment-actions">
                    <view class="action-btn" bindtap="onLikeComment" data-id="{{item.id}}">
                      <text class="action-icon">ğŸ‘</text>
                      <text class="action-text">{{item.likes > 0 ? item.likes : 'èµ'}}</text>
                    </view>
                    <view class="action-btn" bindtap="onReplyComment" data-comment="{{item}}">
                      <text class="action-icon">ğŸ’¬</text>
                      <text class="action-text">å›å¤</text>
                    </view>
                    <view wx:if="{{item.userId === userId}}" class="action-btn" bindtap="onDeleteComment" data-id="{{item.id}}">
                      <text class="action-icon">ğŸ—‘ï¸</text>
                      <text class="action-text">åˆ é™¤</text>
                    </view>
                  </view>

                  <!-- å›å¤åˆ—è¡¨ -->
                  <view wx:if="{{item.replies && item.replies.length > 0}}" class="replies-list">
                    <block wx:for="{{item.replies}}" wx:key="id" wx:for-item="reply">
                      <view class="reply-item">
                        <text class="reply-author">{{reply.user ? reply.user.nickname : 'æ¸¸å®¢'}}</text>
                        <text class="reply-content">: {{reply.content}}</text>
                        <view class="reply-actions">
                          <text class="reply-likes" wx:if="{{reply.likes > 0}}">ğŸ‘ {{reply.likes}}</text>
                        </view>
                      </view>
                    </block>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="bottom-actions">
        <button class="btn-secondary" bindtap="goHome">è¿”å›ä¸»é¡µ</button>
        <button class="btn-primary" bindtap="handleNext">ç»§ç»­æŒ‘æˆ˜</button>
      </view>

    </view>

  </scroll-view>

</view>
