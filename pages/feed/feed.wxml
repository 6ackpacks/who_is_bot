<!--pages/feed/feed.wxml - æ–°ç‰ˆå¡ç‰‡å¼è®¾è®¡-->
<view class="feed-container theme-{{currentTheme}}">

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-container">
    <text class="icon icon-warning icon-xxl icon-warning"></text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="loadFeedData">é‡æ–°åŠ è½½</button>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view wx:if="{{viewState === 'judging'}}" class="judgment-view">

      <!-- æ ‡é¢˜ -->
      <view class="page-title">è°æ˜¯äººæœº?</view>

      <!-- å†…å®¹åŒºåŸŸï¼ˆå¼•å·+å¡ç‰‡ï¼‰ -->
      <view class="content-wrapper">
        <view class="quote-icon">"</view>

        <!-- è§†é¢‘å†…å®¹ -->
        <view wx:if="{{currentItem.type === 'video'}}" class="content-card image-card {{cardSwipeClass}}">
          <view class="content-image-wrapper">
            <video
              id="content-video"
              class="content-video"
              src="{{currentItem.url}}"
              object-fit="contain"
              show-center-play-btn="{{true}}"
              show-play-btn="{{false}}"
              controls="{{true}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
            ></video>
          </view>
        </view>

        <!-- å›¾ç‰‡å†…å®¹ -->
        <view wx:elif="{{currentItem.type === 'image'}}" class="content-card image-card {{cardSwipeClass}}">
          <view class="content-image-wrapper">
            <image class="content-image" src="{{currentItem.url}}" mode="aspectFit"></image>
          </view>
        </view>

        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:else class="content-card {{cardSwipeClass}}">
          <text class="content-text">{{currentItem.text || currentItem.title}}</text>
        </view>
      </view>

      <!-- åˆ¤å®šæŒ‰é’® -->
      <view class="action-buttons {{isItemJudged(currentItem.id) ? 'judged' : ''}}">
        <button
          class="btn-judge btn-ai {{isItemJudged(currentItem.id) ? 'judged' : ''}} {{getUserChoice(currentItem.id) === 'ai' ? 'user-choice' : ''}}"
          bindtap="handleJudge"
          data-choice="ai"
        >
          <text class="btn-text">é“æ˜¯äººæœº</text>
        </button>
        <button
          class="btn-judge btn-human {{isItemJudged(currentItem.id) ? 'judged' : ''}} {{getUserChoice(currentItem.id) === 'human' ? 'user-choice' : ''}}"
          bindtap="handleJudge"
          data-choice="human"
        >
          <text class="btn-text">åŒ…æ˜¯çœŸäºº</text>
        </button>
      </view>

      <!-- æŸ¥çœ‹è§£ææŒ‰é’®ï¼ˆä»…å·²åˆ¤æ–­æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{isItemJudged(currentItem.id)}}" class="view-analysis-container">
        <button class="btn-view-analysis" bindtap="viewAnalysis">
          æŸ¥çœ‹è§£æ
        </button>
      </view>

  </view>

  <!-- åˆ¤å®šåçŠ¶æ€ - è¯„è®º/ç»“æœé¡µé¢ -->
  <view wx:elif="{{viewState === 'revealed'}}" class="result-view">

      <!-- è¿”å›æŒ‰é’® - å·¦ä¸Šè§’ -->
      <view class="back-button" bindtap="goHome">
        <text class="back-icon">â†</text>
        <text class="back-text">è¿”å›</text>
      </view>

      <!-- ç»§ç»­æŒ‘æˆ˜æŒ‰é’® - å³ä¸Šè§’ -->
      <view class="next-button" bindtap="handleNext">
        <text class="next-text">ç»§ç»­æŒ‘æˆ˜</text>
        <text class="next-icon">â†’</text>
      </view>

      <!-- åˆ¤å®šè§†è§‰å®¹å™¨ -->
      <view class="content-card">
        <view class="judgment-visual">
          <!-- æ—‹è½¬æ‰«æè¾¹æ¡† -->
          <view class="scan-overlay"></view>

          <!-- å†…å®¹å®¹å™¨ - 9è¾¹å½¢è£å‰ª -->
          <view class="content-image-container">
            <!-- è§†é¢‘å†…å®¹ -->
            <video
              wx:if="{{currentItem.type === 'video'}}"
              class="content-media"
              src="{{currentItem.url}}"
              object-fit="cover"
              show-center-play-btn="{{true}}"
              show-play-btn="{{false}}"
              controls="{{true}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
            ></video>

            <!-- å›¾ç‰‡å†…å®¹ -->
            <image
              wx:elif="{{currentItem.type === 'image'}}"
              class="content-media"
              src="{{currentItem.url}}"
              mode="aspectFill"
            ></image>

            <!-- æ–‡å­—å†…å®¹ -->
            <view wx:else class="content-text-display">
              <text>{{currentItem.text || currentItem.title}}</text>
            </view>
          </view>

          <!-- æ¥æºæ ‡ç­¾ -->
          <view class="tag-pill">
            <text class="tag-dot">â—</text> æ¥æº: {{currentItem.provider || currentItem.modelTag || 'Unknown'}}
          </view>
        </view>

        <!-- ç»“æœå¤´éƒ¨ - REMOVED "åˆ¤å®šå¤±è¯¯" BUTTON, ONLY STATUS BADGE -->
        <view class="result-header">
          <view class="status-badge">{{isCorrect ? 'åˆ¤å®šæ­£ç¡®' : 'åˆ¤å®šå¤±è¯¯'}}</view>
          <view class="result-main-title">{{currentItem.isAi ? 'AI ç”Ÿæˆå†…å®¹' : 'çœŸäººåˆ›ä½œå†…å®¹'}}</view>
          <view class="result-subtitle">{{isCorrect ? 'ä½ çš„ç›´è§‰å¾ˆå‡†ç¡®ï¼' : 'è¿™æ¬¡æœ‰ç‚¹éš¾åº¦ï¼Œç»§ç»­åŠ æ²¹ï¼'}}</view>
        </view>

        <!-- ç»Ÿè®¡æ˜¾ç¤º -->
        <view class="stats-container">
          <view class="stat-row">
            <text>å…¨ç½‘åˆ¤æ–­ä¸º AI</text>
            <text class="stat-percentage">{{currentItem.aiPercentage || 82}}%</text>
          </view>
          <view class="progress-track">
            <view class="progress-fill" style="width: {{currentItem.aiPercentage || 82}}%"></view>
          </view>
          <view class="stat-meta">
            <text>å…± {{currentItem.totalVotes || 12403}} äººå‚ä¸</text>
            <text>{{100 - (currentItem.aiPercentage || 82)}}% è®¤ä¸ºæ˜¯çœŸäºº</text>
          </view>
        </view>
      </view>

      <!-- è§£æå¡ç‰‡ -->
      <view wx:if="{{currentItem.explanation}}" class="analysis-card" bindtap="toggleAnalysis">
        <view class="analysis-header">
          <text class="analysis-title">âš¡ å®˜æ–¹è§£æ</text>
          <text class="chevron {{analysisExpanded ? 'expanded' : ''}}">â€º</text>
        </view>
        <view class="analysis-content {{analysisExpanded ? 'show' : ''}}">
          {{currentItem.explanation || 'æ³¨æ„è§‚å¯Ÿç»†èŠ‚ç‰¹å¾ï¼ŒAIç”Ÿæˆçš„å†…å®¹å¾€å¾€åœ¨å…‰å½±ã€çº¹ç†ç­‰æ–¹é¢å­˜åœ¨ä¸è‡ªç„¶çš„ç—•è¿¹...'}}
        </view>
      </view>

      <!-- è¯„è®ºåŒºåŸŸ - REMOVED SORT TOGGLE -->
      <view class="comments-section">
        <view class="section-title-row">
          <view class="section-title">è®¨è®º ({{comments.length}})</view>
        </view>

        <!-- è¯„è®ºè¾“å…¥æ¡† - å†…è”ä½ç½® -->
        <view class="comment-input-container">
          <input
            class="comment-input-field"
            placeholder="{{replyingTo ? 'å›å¤ ' + replyingTo.user.nickname : 'å‘è¡¨ä½ çš„è§‚ç‚¹...'}}"
            value="{{commentInput}}"
            bindinput="onCommentInput"
            maxlength="500"
            confirm-type="send"
            bindconfirm="submitComment"
          />
          <view class="comment-send-btn" bindtap="submitComment">
            <text class="send-icon">â¤</text>
          </view>
        </view>

        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comments-list">
          <view wx:if="{{comments.length === 0}}" class="empty-comments">
            <text class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
          </view>

          <block wx:for="{{comments}}" wx:key="id">
            <view class="comment-item">
              <!-- ç”¨æˆ·å¤´åƒ - åœ†è§’æ–¹å½¢ -->
              <image
                class="avatar"
                src="{{item.user ? item.user.avatar : 'https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132'}}"
                mode="aspectFill"
              />

              <view class="comment-body">
                <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ—¶é—´ -->
                <view class="comment-meta">
                  <view class="username-row">
                    <text class="username">{{item.user ? item.user.nickname : 'æ¸¸å®¢'}}</text>
                    <text wx:if="{{item.isPinned}}" class="pin-badge">ç²¾é€‰</text>
                  </view>
                  <text class="comment-time">{{item.createdAt}}</text>
                </view>

                <!-- è¯„è®ºå†…å®¹ -->
                <view class="comment-text">{{item.content}}</view>

                <!-- æ“ä½œæŒ‰é’® -->
                <view class="comment-actions">
                  <view class="action-btn" bindtap="onLikeComment" data-id="{{item.id}}">
                    <text class="like-icon">ğŸ‘</text>
                    <text class="action-count">{{item.likes > 0 ? item.likes : 'èµ'}}</text>
                  </view>
                  <view class="action-btn" bindtap="onReplyComment" data-comment="{{item}}">
                    <text>å›å¤</text>
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>

  </view>

</view>
