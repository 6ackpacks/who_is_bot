<!--pages/feed/feed.wxml - 新版卡片式设计-->
<view class="feed-container theme-{{currentTheme}}">

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="error-container">
    <text class="icon icon-warning icon-xxl icon-warning"></text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="loadFeedData">重新加载</button>
  </view>

  <!-- 主内容区域 - 滚动视图 -->
  <scroll-view wx:else scroll-y="{{viewState !== 'judging'}}" class="feed-scroll">

    <!-- 判定前状态 -->
    <view wx:if="{{viewState === 'judging'}}" class="judgment-view">

      <!-- 标题 -->
      <view class="page-title">谁是人机?</view>

      <!-- 内容区域（引号+卡片） -->
      <view class="content-wrapper">
        <view class="quote-icon">"</view>

        <!-- 视频内容 -->
        <view wx:if="{{currentItem.type === 'video'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <video
              id="content-video"
              class="content-video"
              src="{{currentItem.url}}"
              object-fit="contain"
              show-center-play-btn="{{true}}"
              show-play-btn="{{false}}"
              controls="{{true}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
            ></video>
          </view>
        </view>

        <!-- 图片内容 -->
        <view wx:elif="{{currentItem.type === 'image'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <image class="content-image" src="{{currentItem.url}}" mode="aspectFit"></image>
          </view>
        </view>

        <!-- 文字内容 -->
        <view wx:else class="content-card">
          <text class="content-text">{{currentItem.text || currentItem.title}}</text>
        </view>
      </view>

      <!-- 判定按钮 -->
      <view class="action-buttons">
        <button class="btn-judge btn-ai" bindtap="handleJudge" data-choice="ai">
          该是人机!
        </button>
        <button class="btn-judge btn-human" bindtap="handleJudge" data-choice="human">
          包真人的!
        </button>
      </view>

    </view>

    <!-- 判定后状态 -->
    <view wx:elif="{{viewState === 'revealed'}}" class="result-view">

      <!-- 结果提示 -->
      <view class="result-header">
        <text class="result-title">{{isCorrect ? '你真是别具慧眼！选择与结果一致！' : '很遗憾，这次判断失误了'}}</text>
      </view>

      <!-- 统计条 -->
      <view class="stats-bar">
        <view class="stat-item stat-ai" style="width: {{currentItem.aiPercentage || 28}}%">
          <text class="stat-text">{{currentItem.aiPercentage || 28}}%</text>
        </view>
        <view class="stat-item stat-human" style="width: {{100 - (currentItem.aiPercentage || 28)}}%">
          <text class="stat-text">{{100 - (currentItem.aiPercentage || 28)}}%</text>
        </view>
      </view>

      <!-- 来源信息 -->
      <view class="source-info">
        该内容是 {{currentItem.isAi ? '' : ''}} <text wx:if="{{currentItem.isAi}}" class="icon icon-robot icon-sm"></text><text wx:else class="icon icon-user icon-sm"></text> {{currentItem.isAi ? 'AI' : '真人'}} {{currentItem.provider}} 数据提供。
      </view>

      <!-- 内容卡片 -->
      <view class="content-card-wrapper">
        <view class="quote-icon">"</view>

        <!-- 视频内容 -->
        <view wx:if="{{currentItem.type === 'video'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <video
              id="result-video"
              class="content-video"
              src="{{currentItem.url}}"
              object-fit="contain"
              show-center-play-btn="{{true}}"
              show-play-btn="{{false}}"
              controls="{{true}}"
              bindplay="onVideoPlay"
              bindpause="onVideoPause"
              binderror="onVideoError"
            ></video>
          </view>
        </view>

        <!-- 图片内容 -->
        <view wx:elif="{{currentItem.type === 'image'}}" class="content-card image-card">
          <view class="content-image-wrapper">
            <image class="content-image" src="{{currentItem.url}}" mode="aspectFit"></image>
          </view>
        </view>

        <!-- 文字内容 -->
        <view wx:else class="content-card">
          <text class="content-text">{{currentItem.text || currentItem.title}}</text>
        </view>
      </view>

      <!-- 解析说明 -->
      <view wx:if="{{currentItem.explanation}}" class="explanation-box">
        <text class="explanation-label">该内容是 {{currentItem.modelTag}} 生成</text>
        <text class="explanation-text">{{currentItem.explanation}}</text>
      </view>

      <!-- 评论区域 -->
      <view class="comments-section">
        <view class="comments-header">
          <text class="comments-title"><text class="icon icon-comment icon-sm"></text> 大家的评论 ({{comments.length}})</text>
        </view>

        <!-- 评论输入框 -->
        <view class="comment-input-wrapper">
          <input
            class="comment-input"
            placeholder="{{replyingTo ? '回复 ' + replyingTo.user.nickname : '说点什么...'}}"
            value="{{commentInput}}"
            bindinput="onCommentInput"
            maxlength="500"
            confirm-type="send"
            bindconfirm="submitComment"
          />
          <button class="comment-submit-btn" bindtap="submitComment">发送</button>
        </view>

        <!-- 评论列表 -->
        <view class="comments-list">
          <view wx:if="{{comments.length === 0}}" class="empty-comments">
            <text class="empty-text">暂无评论，快来抢沙发吧~</text>
          </view>

          <block wx:for="{{comments}}" wx:key="id">
            <view class="comment-item">
              <!-- 用户头像 -->
              <image
                class="comment-avatar"
                src="{{item.user ? item.user.avatar : 'https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132'}}"
                mode="aspectFill"
              />

              <view class="comment-main">
                <!-- 用户信息和时间 -->
                <view class="comment-header">
                  <text class="comment-nickname">{{item.user ? item.user.nickname : '游客'}}</text>
                  <text wx:if="{{item.user}}" class="comment-level">Lv.{{item.user.level}}</text>
                  <text class="comment-time">{{item.createdAt}}</text>
                </view>

                <!-- 评论内容 -->
                <text class="comment-content">{{item.content}}</text>

                <!-- 操作按钮 -->
                <view class="comment-actions">
                  <view class="action-btn" bindtap="onLikeComment" data-id="{{item.id}}">
                    <text class="icon icon-like icon-sm"></text>
                    <text class="action-text">{{item.likes > 0 ? item.likes : '赞'}}</text>
                  </view>
                  <view class="action-btn" bindtap="onReplyComment" data-comment="{{item}}">
                    <text class="icon icon-comment icon-sm"></text>
                    <text class="action-text">回复</text>
                  </view>
                  <view wx:if="{{item.userId === userId}}" class="action-btn" bindtap="onDeleteComment" data-id="{{item.id}}">
                    <text class="icon icon-delete icon-sm"></text>
                    <text class="action-text">删除</text>
                  </view>
                </view>

                <!-- 回复列表 -->
                <view wx:if="{{item.replies && item.replies.length > 0}}" class="replies-list">
                  <block wx:for="{{item.replies}}" wx:key="id" wx:for-item="reply">
                    <view class="reply-item">
                      <text class="reply-author">{{reply.user ? reply.user.nickname : '游客'}}</text>
                      <text class="reply-content">: {{reply.content}}</text>
                      <view class="reply-actions">
                        <text class="reply-likes" wx:if="{{reply.likes > 0}}">
                          <text class="icon icon-like icon-xs"></text> {{reply.likes}}
                        </text>
                      </view>
                    </view>
                  </block>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 底部按钮 -->
      <view class="bottom-actions">
        <button class="btn-secondary" bindtap="goHome">返回主页</button>
        <button class="btn-primary" bindtap="handleNext">继续挑战</button>
      </view>

    </view>

  </scroll-view>

</view>
