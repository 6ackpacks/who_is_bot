# 微信小程序视频播放问题排查与解决方案

## 项目背景

**项目名称：** 谁是人机？(Who is the Bot?)
**技术栈：** 微信小程序 + NestJS 后端 + MySQL + 微信云托管
**核心功能：** AI生成内容识别游戏，需要播放视频内容供用户判断

---

## 问题时间线

### 阶段1：后端部署失败

#### 问题表现
```
Error: not node js file system!path:/saaa_config.json
```

#### 根本原因
- NestJS 的 `@nestjs/config` 模块默认尝试从文件系统读取 `.env` 文件
- 微信云托管环境限制文件系统访问
- 导致应用启动时报错

#### 解决方案
```typescript
// services/src/app.module.ts
ConfigModule.forRoot({
  isGlobal: true,
  ignoreEnvFile: true,  // 禁用 .env 文件加载
  envFilePath: [],      // 明确禁止文件系统访问
})
```

**关键点：** 云托管环境应通过环境变量配置，而不是 .env 文件

---

### 阶段2：容器启动超时

#### 问题表现
```
Error: errCode: 102002 | errMsg: 请求超时
```
- 容器启动耗时超过15秒
- 小程序调用 `wx.cloud.callContainer` 超时

#### 根本原因
1. **Dockerfile 启动命令错误**
   ```dockerfile
   # 错误
   CMD ["node", "dist/main"]

   # 正确
   CMD ["node", "dist/main.js"]
   ```

2. **数据库连接阻塞启动**
   - TypeORM 尝试连接数据库
   - 环境变量未配置，连接失败
   - 重试逻辑（3次 × 3秒）导致启动延迟

#### 解决方案

**1. 修复启动命令**
```dockerfile
CMD ["node", "dist/main.js"]
```

**2. 使数据库配置可选**
```typescript
// 检查是否配置了数据库
const isDatabaseConfigured = process.env.DB_HOST &&
                             process.env.DB_HOST !== 'localhost';

if (isDatabaseConfigured) {
  // 启用 TypeORM
} else {
  console.warn('Database not configured, running without database');
}
```

**3. 添加健康检查端点**
```typescript
@Get('health')
health() {
  return { status: 'ok', timestamp: new Date().toISOString() };
}
```

---

### 阶段3：视频播放失败 - OSS问题

#### 问题表现
```
Failed to load media https://who-is-the-bot-assets.oss-cn-hangzhou.aliyuncs.com/川普整活.mp4
404 Not Found
```

#### 根本原因
1. **OSS默认域名限制**
   - 阿里云OSS默认域名会添加 `x-oss-force-download` 响应头
   - 导致浏览器下载而不是播放
   - 小程序 `<video>` 组件无法解析

2. **文件不存在**
   - 数据库中存储的视频URL指向不存在的文件

#### 解决方案

**方案A：视频代理接口（已实现）**
```typescript
// services/src/proxy.controller.ts
@Get('video')
async proxyVideo(@Query('url') url: string, @Res() res: Response) {
  // 移除 x-oss-force-download 响应头
  res.setHeader('Content-Disposition', 'inline');
  // 代理视频流
  proxyRes.pipe(res);
}
```

**使用方式：**
```
https://你的云托管域名/proxy/video?url=<编码后的OSS-URL>
```

**方案B：使用微信云存储（推荐）**
- 上传视频到微信云存储
- 使用 `cloud://` 协议的 fileID
- 无需配置域名白名单
- 自动CDN加速

---

### 阶段4：视频播放失败 - 域名白名单

#### 问题表现
```
Failed to load media https://www.w3schools.com/html/mov_bbb.mp4
net::ERR_FAILED
```
- 测试视频（公开可访问的MP4）也无法加载
- 说明不是OSS特定问题

#### 根本原因
**微信小程序的域名白名单限制**
- 所有网络请求必须使用 HTTPS
- 域名必须在微信公众平台配置的白名单中
- 开发阶段可以关闭校验，但生产环境必须配置

#### 解决方案

**开发阶段：**
1. 打开微信开发者工具
2. 点击右上角"详情"
3. 选择"本地设置"
4. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

**生产环境：**
1. 登录微信公众平台（mp.weixin.qq.com）
2. 进入：开发 → 开发管理 → 开发设置 → 服务器域名
3. 在"request合法域名"中添加：
   ```
   https://你的云托管域名
   ```

---

### 阶段5：数据绑定问题

#### 问题表现
- 后端API成功返回数据
- 控制台显示 `{data: Array(4), statusCode: 200}`
- 但页面显示 `null`

#### 排查过程

**1. 检查数据流**
```javascript
console.log('Raw Data Item:', res.data[0]);
console.log('Data keys:', Object.keys(res.data[0]));
console.log('Title value:', res.data[0].title);
console.log('URL value:', res.data[0].url);
```

**2. 检查字段映射**
```typescript
// 后端 Entity
@Column({ type: 'varchar', length: 255 })
title: string;

@Column({ type: 'text', nullable: true })
url: string;
```

**3. 检查 setData**
```javascript
this.setData({
  items: res.data,
  currentItem: res.data[0],
  loading: false
}, () => {
  console.log('Data set complete:', this.data.currentItem);
});
```

#### 根本原因
- 添加了测试数据，覆盖了真实数据
- 测试数据使用外部URL，被域名白名单阻止

#### 解决方案
```javascript
// 直接使用后端返回的数据
this.setData({
  items: res.data,
  currentItem: res.data[0],
  loading: false
});
```

---

### 阶段6：渲染层问题

#### 问题表现
- 逻辑层数据100%正确
- `console.log` 显示 title 和 url 都有值
- 但页面仍然不显示或视频不播放

#### 根本原因

**1. 缺少云开发配置**
```json
// app.json 缺少
"cloud": true
```
- 导致 `cloud://` 协议无法被解析

**2. 视频组件条件渲染缺失**
```xml
<!-- 问题：即使 URL 为空也会渲染 -->
<video src="{{currentItem.url}}"></video>
```

**3. 样式可能导致不可见**
- 没有明确的宽高
- 可能被其他样式覆盖

#### 解决方案

**1. 启用云开发**
```json
{
  "pages": [...],
  "cloud": true,
  "window": {...}
}
```

**2. 添加条件渲染**
```xml
<video
  wx:if="{{currentItem.url}}"
  src="{{currentItem.url}}"
  class="content-video"
  controls
  binderror="onVideoError"
  style="width: 750rpx; height: 450rpx;"
></video>
```

**3. 添加错误处理**
```javascript
onVideoError(e) {
  console.error('Video Error Details:', e.detail);
  console.error('Video Error Message:', e.detail.errMsg);
  console.error('Current video URL:', this.data.currentItem?.url);
  wx.showToast({
    title: '视频加载失败',
    icon: 'none'
  });
}
```

---

## 最终解决方案

### 推荐架构

```
┌─────────────────┐
│  微信小程序      │
│  (前端)         │
└────────┬────────┘
         │
         │ cloud://fileID
         │
┌────────▼────────┐
│  微信云存储      │
│  (视频托管)     │
└─────────────────┘
```

### 实施步骤

#### 1. 上传视频到微信云存储

**方法A：通过开发者工具**
1. 打开微信开发者工具
2. 点击"云开发"控制台
3. 选择"存储"
4. 上传视频文件
5. 获取 fileID（格式：`cloud://环境ID.xxx/文件路径`）

**方法B：通过代码上传**
```javascript
wx.cloud.uploadFile({
  cloudPath: 'videos/sample.mp4',
  filePath: tempFilePath,
  success: res => {
    console.log('FileID:', res.fileID);
    // 将 fileID 保存到数据库
  }
});
```

#### 2. 更新数据库

```sql
UPDATE content
SET url = 'cloud://prod-3ge8ht6pded7ed77.xxx/videos/sample.mp4'
WHERE id = 'xxx';
```

#### 3. 确保配置正确

**app.json**
```json
{
  "cloud": true
}
```

**app.js**
```javascript
App({
  onLaunch() {
    wx.cloud.init({
      env: 'prod-3ge8ht6pded7ed77',  // 你的云环境ID
      traceUser: true
    });
  }
})
```

#### 4. 测试验证

```javascript
// 在 feed.js 中添加日志
console.log('Video URL:', this.data.currentItem.url);
// 应该输出：cloud://prod-3ge8ht6pded7ed77.xxx/videos/sample.mp4
```

---

## 调试技巧

### 1. 数据流调试

```javascript
// 在 API 成功回调中
success: res => {
  console.log('=== API Response ===');
  console.log('Status:', res.statusCode);
  console.log('Data length:', res.data.length);
  console.log('First item:', res.data[0]);
  console.log('Keys:', Object.keys(res.data[0]));
  console.log('Title:', res.data[0].title);
  console.log('URL:', res.data[0].url);
  console.log('==================');
}
```

### 2. 渲染调试

```javascript
// 在 setData 回调中
this.setData({...}, () => {
  console.log('=== After setData ===');
  console.log('Current item:', this.data.currentItem);
  console.log('Title:', this.data.currentItem.title);
  console.log('URL:', this.data.currentItem.url);
  console.log('====================');
});
```

### 3. 视频错误调试

```xml
<video binderror="onVideoError"></video>
```

```javascript
onVideoError(e) {
  console.error('=== Video Error ===');
  console.error('Error detail:', e.detail);
  console.error('Error message:', e.detail.errMsg);
  console.error('Video URL:', this.data.currentItem?.url);
  console.error('==================');
}
```

---

## 常见错误代码

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| `net::ERR_FAILED` | 网络请求失败 | 检查域名白名单配置 |
| `net::ERR_NAME_NOT_RESOLVED` | DNS解析失败 | 检查网络连接或域名 |
| `404 Not Found` | 文件不存在 | 检查URL是否正确 |
| `errCode: 102002` | 请求超时 | 检查后端服务是否正常启动 |
| `cloud.callContainer:fail` | 云托管调用失败 | 检查服务配置和环境变量 |

---

## 性能优化建议

### 1. 视频预加载

```xml
<video
  src="{{currentItem.url}}"
  preload="auto"
></video>
```

### 2. 使用封面图

```xml
<video
  src="{{currentItem.url}}"
  poster="{{currentItem.coverUrl}}"
></video>
```

### 3. 视频压缩

- 使用 H.264 编码
- 分辨率：720p 或 1080p
- 码率：1-3 Mbps
- 格式：MP4

### 4. CDN加速

微信云存储自动提供CDN加速，无需额外配置。

---

## 安全注意事项

### 1. 视频代理接口

```typescript
// 必须验证URL，防止SSRF攻击
const allowedDomains = [
  'who-is-the-bot-assets.oss-cn-hangzhou.aliyuncs.com',
  'aliyuncs.com'
];

const isAllowed = allowedDomains.some(domain =>
  parsedUrl.hostname.endsWith(domain)
);

if (!isAllowed) {
  throw new HttpException('Domain not allowed', HttpStatus.FORBIDDEN);
}
```

### 2. 云存储权限

```json
{
  "permissions": {
    "openapi": [
      "storage.uploadFile",
      "storage.downloadFile"
    ]
  }
}
```

---

## 总结

### 问题根源
1. **后端配置问题** - 云托管环境的特殊性
2. **网络限制** - 小程序的域名白名单机制
3. **数据流问题** - 测试数据干扰
4. **渲染配置** - 缺少云开发支持

### 最佳实践
1. ✅ 使用微信云存储托管视频
2. ✅ 使用 `cloud://` 协议
3. ✅ 添加完善的错误处理
4. ✅ 添加详细的调试日志
5. ✅ 配置条件渲染避免空值

### 关键配置清单
- [ ] app.json 添加 `"cloud": true`
- [ ] app.js 初始化云开发 `wx.cloud.init()`
- [ ] 视频上传到云存储
- [ ] 数据库存储 cloud:// fileID
- [ ] 添加 binderror 错误处理
- [ ] 添加 wx:if 条件渲染
- [ ] 设置明确的宽高样式

---

## 参考资源

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [云存储使用指南](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/storage.html)
- [video 组件文档](https://developers.weixin.qq.com/miniprogram/dev/component/video.html)

---

**文档版本：** 1.0
**最后更新：** 2026-01-26
**维护者：** Claude Sonnet 4.5
